/**
 * Ce fichier configure une instance Axios personnalisÃ©e avec:
 * - Configuration de base (URL, headers)
 * - Intercepteurs pour la gestion automatique des tokens
 * - Gestion des erreurs d'authentification (401)
 * - IntÃ©gration conditionnelle des mocks en dÃ©veloppement
 */

// Importation des modules nÃ©cessaires
import axios from 'axios';                 // BibliothÃ¨que principale pour les requÃªtes HTTP
import { getToken, removeToken } from './token';  // Utilitaires pour manipuler le token JWT
import setupMock from './mockAdapter';     // Configuration des mocks (utilisÃ© en dÃ©veloppement uniquement)

// RÃ©cupÃ©ration de l'URL de l'API depuis les variables d'environnement ou utilisation d'une URL par dÃ©faut
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000/api';
const ENABLE_MOCKS = import.meta.env.VITE_ENABLE_MOCKS === 'true' || import.meta.env.DEV;

// Debug des variables d'environnement
console.log('ðŸ”§ Configuration Axios:');
console.log('- API_URL:', API_URL);
console.log('- ENABLE_MOCKS:', ENABLE_MOCKS);
console.log('- NODE_ENV:', import.meta.env.MODE);
console.log('- DEV mode:', import.meta.env.DEV);

/**
 * CrÃ©ation d'une instance Axios personnalisÃ©e
 * Cette instance sera utilisÃ©e pour toutes les requÃªtes API dans l'application
 */
const axiosInstance = axios.create({
  baseURL: API_URL,                    // URL de base qui sera prÃ©fixÃ©e Ã  toutes les requÃªtes
  headers: {
    'Content-Type': 'application/json',  // En-tÃªte par dÃ©faut pour toutes les requÃªtes
  },
  timeout: 10000, // Timeout de 10 secondes
});

/**
 * Intercepteur de requÃªtes
 * ExÃ©cutÃ© avant chaque requÃªte pour:
 * - Ajouter automatiquement le token JWT aux en-tÃªtes si disponible
 */
axiosInstance.interceptors.request.use(
  (_config) => {
    // RÃ©cupÃ©ration du token JWT depuis le stockage local via notre utilitaire
    const token = getToken();
    
    // Si un token existe, l'ajouter Ã  l'en-tÃªte Authorization
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    
    // Log pour debug
    console.log('ðŸ“¤ RequÃªte:', config.method?.toUpperCase(), config.url);
    
    // Retour de la configuration modifiÃ©e
    return config;
  },
  // En cas d'erreur lors de la prÃ©paration de la requÃªte
  (error) => {
    console.error('âŒ Erreur de requÃªte:', error);
    return Promise.reject(error);
  }
);

/**
 * Intercepteur de rÃ©ponses
 * ExÃ©cutÃ© aprÃ¨s chaque rÃ©ponse pour:
 * - GÃ©rer les erreurs d'authentification (code 401)
 * - Rediriger vers la page de login si le token est invalide/expirÃ©
 */
axiosInstance.interceptors.response.use(
  // Pour les rÃ©ponses rÃ©ussies, renvoyer simplement la rÃ©ponse
  (response) => {
    console.log('ðŸ“¥ RÃ©ponse:', response.status, response.config.url);
    return response;
  },
  
  // Pour les erreurs, vÃ©rifier si c'est une erreur 401 (non autorisÃ©)
  (error) => {
    console.error('âŒ Erreur de rÃ©ponse:', error.response?.status, error.config?.url);
    
    if (error.response && error.response.status === 401) {
      // Si erreur 401, supprimer le token et rediriger vers la page de login
      removeToken();
      
      // Redirection vers la page de login
      // Utilisation de window.location.href pour une redirection complÃ¨te de la page
      window.location.href = '/login';
    }
    
    // Propager l'erreur pour qu'elle puisse Ãªtre gÃ©rÃ©e ailleurs si nÃ©cessaire
    return Promise.reject(error);
  }
);

/**
 * Configuration des mocks en mode dÃ©veloppement
 * Permet de dÃ©velopper le frontend sans avoir besoin d'un backend fonctionnel
 */
if (ENABLE_MOCKS) {
  // Afficher un message dans la console pour indiquer que les mocks sont activÃ©s
  console.log('ðŸŽ­ API Mock activÃ© en environnement de dÃ©veloppement');
  
  // Configurer les mocks avec notre instance Axios
  setupMock(axiosInstance);
} else {
  console.log('ðŸŒ Utilisation de l\'API rÃ©elle:', API_URL);
}

// Exportation de l'instance Axios configurÃ©e pour utilisation dans toute l'application
export default axiosInstance;

/**
 * Utilisation typique dans l'application:
 * 
 * import axiosInstance from '../utils/axios';
 * 
 * // Faire une requÃªte GET
 * const getData = async () => {
 *   try {
 *     const response = await axiosInstance.get('/endpoint');
 *     return response.data;
 *   } catch (_error) {
 *     console.error('Erreur:', error);
 *     throw error;
 *   }
 * };
 * 
 * // Faire une requÃªte POST
 * const createData = async (data) => {
 *   try {
 *     const response = await axiosInstance.post('/endpoint', data);
 *     return response.data;
 *   } catch (_error) {
 *     console.error('Erreur:', error);
 *     throw error;
 *   }
 * };
 */